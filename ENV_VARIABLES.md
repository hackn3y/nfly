# Environment Variables Reference

Complete list of environment variables required for NFL Predictor deployment.

## Backend Service (Railway)

### Required Variables

| Variable | Description | Example | Where to Get |
|----------|-------------|---------|--------------|
| `NODE_ENV` | Environment mode | `production` | Set manually |
| `PORT` | Server port | `4100` | Auto-set by Railway |
| `DATABASE_URL` | PostgreSQL connection | `postgresql://...` | Auto-generated by Railway |
| `MONGODB_URI` | MongoDB connection | `mongodb+srv://...` | MongoDB Atlas dashboard |
| `REDIS_URL` | Redis connection | `redis://...` | Auto-generated by Railway |
| `JWT_SECRET` | JWT signing secret | `random-256-bit-string` | Generate secure random string |
| `ML_SERVICE_URL` | ML service endpoint | `http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080` | Railway variable reference |

### Email Configuration (SendGrid)

| Variable | Description | Example |
|----------|-------------|---------|
| `SMTP_HOST` | SendGrid SMTP host | `smtp.sendgrid.net` |
| `SMTP_PORT` | SMTP port | `587` |
| `SMTP_USER` | SendGrid username | `apikey` |
| `SMTP_PASS` | SendGrid API key | `SG.xxxxx` |
| `EMAIL_FROM` | From email address | `noreply@yourdomain.com` |

**How to get SendGrid API key:**
1. Sign up at https://sendgrid.com
2. Go to Settings → API Keys
3. Create new API key with "Mail Send" permission

### Stripe Configuration

| Variable | Description | Example | Where to Get |
|----------|-------------|---------|--------------|
| `STRIPE_SECRET_KEY` | Stripe secret key | `sk_test_...` or `sk_live_...` | Stripe Dashboard → Developers → API Keys |
| `STRIPE_WEBHOOK_SECRET` | Webhook signing secret | `whsec_...` | Stripe Dashboard → Developers → Webhooks |
| `STRIPE_PREMIUM_PRICE_ID` | Premium tier price ID | `price_...` | Stripe Dashboard → Products |
| `STRIPE_PRO_PRICE_ID` | Pro tier price ID | `price_...` | Stripe Dashboard → Products |

**Stripe Setup:**
1. Create products in Stripe Dashboard:
   - Premium: $9.99/month recurring
   - Pro: $29.99/month recurring
2. Copy Price IDs (not Product IDs)
3. Create webhook endpoint pointing to: `https://your-backend-url.railway.app/api/webhooks/stripe`
4. Select events: `customer.subscription.*`, `invoice.payment_*`, `checkout.session.completed`

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `FRONTEND_URL` | Allowed CORS origins (comma-separated) | `https://nfly.netlify.app` |
| `ENABLE_SCHEDULER` | Enable/disable cron jobs | `true` |
| `RATE_LIMIT_WINDOW_MS` | Rate limit window (ms) | `900000` (15 min) |
| `RATE_LIMIT_MAX_REQUESTS` | Max requests per window | `100` |
| `LOG_LEVEL` | Winston log level | `info` |

---

## ML Service (Railway)

### Required Variables

| Variable | Description | Example | Source |
|----------|-------------|---------|--------|
| `DATABASE_URL` | PostgreSQL connection | `postgresql://...` | Copy from backend service |
| `REDIS_URL` | Redis connection | `redis://...` | Copy from backend service |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DEBUG` | Enable debug mode | `false` |
| `MODEL_PATH` | Path to ML models | `/app/models` |
| `PORT` | Service port | `8080` |

---

## Mobile App (Expo)

### Configuration File: `packages/mobile/app.json`

```json
{
  "expo": {
    "extra": {
      "apiUrl": "https://nfl-predictorbackend-production.up.railway.app/api"
    }
  }
}
```

**Note**: No `.env` file needed for mobile. Configuration is in `app.json`.

---

## Local Development

### Backend `.env` (packages/backend/.env)

```bash
# Copy from .env.example and fill in values

NODE_ENV=development
PORT=4100

# Local databases (use docker-compose)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/nfl_predictor
MONGODB_URI=mongodb://localhost:27017/nfl_gematria
REDIS_URL=redis://localhost:6379

# Generate random string for development
JWT_SECRET=dev-secret-change-in-production

# Point to local ML service
ML_SERVICE_URL=http://localhost:5000

# Email (optional for development)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=your-sendgrid-api-key
EMAIL_FROM=noreply@localhost

# Stripe (use test keys)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PREMIUM_PRICE_ID=price_...
STRIPE_PRO_PRICE_ID=price_...

# Development settings
ENABLE_SCHEDULER=false
FRONTEND_URL=http://localhost:8100
```

### ML Service `.env` (packages/ml-service/.env)

```bash
# Local databases
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/nfl_predictor
REDIS_URL=redis://localhost:6379

# Development settings
DEBUG=true
PORT=5000
```

---

## Security Best Practices

### 1. Secret Generation

Generate secure random strings for `JWT_SECRET`:

```bash
# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Using OpenSSL
openssl rand -hex 32

# Using Python
python -c "import secrets; print(secrets.token_hex(32))"
```

### 2. Environment Variable Security

- ✅ **DO**: Store secrets in Railway/Netlify environment variables
- ✅ **DO**: Use different secrets for dev/staging/production
- ✅ **DO**: Rotate secrets regularly
- ❌ **DON'T**: Commit `.env` files to Git
- ❌ **DON'T**: Share secrets in Slack/email
- ❌ **DON'T**: Use the same secrets across environments

### 3. MongoDB Atlas Security

- Enable IP whitelist (add Railway IPs)
- Use strong passwords (20+ characters)
- Enable database encryption at rest
- Regularly review database access logs

### 4. Stripe Security

- Use test keys (`sk_test_`) for development
- Use live keys (`sk_live_`) only in production
- Enable webhook signature verification (already implemented)
- Monitor Stripe Dashboard for suspicious activity

---

## Troubleshooting

### "JWT_SECRET is not defined"

**Problem**: Backend fails to start
**Solution**: Add `JWT_SECRET` to Railway environment variables

### "Cannot connect to MongoDB"

**Problem**: MongoDB connection timeout
**Solution**:
1. Check `MONGODB_URI` format
2. Verify network access in MongoDB Atlas (allow 0.0.0.0/0)
3. Check username/password are correct

### "ML Service connection failed"

**Problem**: Backend returns 502 when calling predictions
**Solution**:
1. Verify ML service is running in Railway
2. Check `ML_SERVICE_URL` uses private domain syntax:
   ```
   http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080
   ```
3. Ensure ML service has `DATABASE_URL` and `REDIS_URL` set

### "CORS error in browser"

**Problem**: Frontend can't call backend API
**Solution**:
1. Add Netlify URL to `FRONTEND_URL` in backend
2. Format: `https://nfly.netlify.app` (no trailing slash)
3. For multiple origins: `https://nfly.netlify.app,https://custom-domain.com`

---

## Environment Variable Checklist

### Before Deploying to Production

Backend:
- [ ] `JWT_SECRET` is set to secure random string
- [ ] `MONGODB_URI` points to MongoDB Atlas
- [ ] `ML_SERVICE_URL` uses Railway private domain
- [ ] `FRONTEND_URL` matches Netlify URL
- [ ] All Stripe keys are production keys (`sk_live_`, `price_live_`)
- [ ] Email SMTP credentials are valid
- [ ] `NODE_ENV=production`

ML Service:
- [ ] `DATABASE_URL` matches backend
- [ ] `REDIS_URL` matches backend
- [ ] `DEBUG=false`

Mobile:
- [ ] `app.json` → `extra.apiUrl` points to Railway backend

---

## Quick Copy Templates

### Railway Backend (Production)

```bash
NODE_ENV=production
DATABASE_URL=<auto-generated>
REDIS_URL=<auto-generated>
MONGODB_URI=mongodb+srv://<username>:<password>@<cluster>.mongodb.net/nfl_gematria?retryWrites=true&w=majority
JWT_SECRET=<generate-secure-random>
ML_SERVICE_URL=http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080
FRONTEND_URL=https://nfly.netlify.app
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=<sendgrid-api-key>
EMAIL_FROM=noreply@yourdomain.com
STRIPE_SECRET_KEY=sk_live_<your-key>
STRIPE_WEBHOOK_SECRET=whsec_<your-secret>
STRIPE_PREMIUM_PRICE_ID=price_<your-id>
STRIPE_PRO_PRICE_ID=price_<your-id>
ENABLE_SCHEDULER=true
```

### Railway ML Service

```bash
DATABASE_URL=<copy-from-backend>
REDIS_URL=<copy-from-backend>
DEBUG=false
PORT=8080
```

---

## Additional Resources

- [Railway Environment Variables](https://docs.railway.app/develop/variables)
- [MongoDB Atlas Connection Strings](https://www.mongodb.com/docs/manual/reference/connection-string/)
- [Stripe API Keys](https://stripe.com/docs/keys)
- [SendGrid API Keys](https://docs.sendgrid.com/ui/account-and-settings/api-keys)
