# NFL Predictor - Deployment Guide

This guide covers deploying the NFL Predictor application to production.

## Architecture Overview

- **Frontend**: Netlify (Expo Web)
- **Backend API**: Railway (Node.js/Express)
- **ML Service**: Railway (Python/FastAPI)
- **Databases**:
  - PostgreSQL (Railway)
  - MongoDB (MongoDB Atlas)
  - Redis (Railway)

## Production URLs

- **App**: https://nfly.netlify.app/
- **Backend API**: https://nfl-predictorbackend-production.up.railway.app/api
- **Health Check**: https://nfl-predictorbackend-production.up.railway.app/health
- **ML Service**: Private (Railway internal networking)

---

## Prerequisites

1. **Accounts Required**:
   - GitHub account (for code hosting)
   - Railway account (for backend & ML service)
   - MongoDB Atlas account (for MongoDB database)
   - Netlify account (for frontend hosting)
   - Stripe account (for payment processing)
   - SendGrid account (for email)

2. **Local Setup**:
   - Node.js 18+ installed
   - Python 3.10+ installed
   - Git installed

---

## Part 1: Database Setup

### MongoDB Atlas Setup

1. Go to [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. Create a free cluster
3. Create database user:
   - Username: `nfluser` (or your choice)
   - Password: Generate secure password
4. Configure Network Access:
   - Add IP: `0.0.0.0/0` (allow from anywhere)
5. Get connection string:
   ```
   mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/nfl_gematria?retryWrites=true&w=majority
   ```

---

## Part 2: Railway Backend Deployment

### Step 1: Create Railway Project

1. Go to [Railway](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose your `nfly` repository
5. Select `packages/backend` as root directory

### Step 2: Add PostgreSQL Database

1. In your Railway project, click "+ New"
2. Select "Database" → "PostgreSQL"
3. Railway automatically creates `DATABASE_URL` variable

### Step 3: Add Redis Database

1. Click "+ New" again
2. Select "Database" → "Redis"
3. Railway automatically creates `REDIS_URL` variable

### Step 4: Configure Backend Environment Variables

Go to your backend service settings → Variables, and add:

```bash
# Node Environment
NODE_ENV=production

# Database URLs (auto-generated)
DATABASE_URL=<auto-generated by Railway>
REDIS_URL=<auto-generated by Railway>

# MongoDB (from MongoDB Atlas)
MONGODB_URI=mongodb+srv://<user>:<pass>@cluster0.xxxxx.mongodb.net/nfl_gematria?retryWrites=true&w=majority

# JWT Secret (generate random string)
JWT_SECRET=<generate-secure-random-string>

# ML Service URL (will configure after ML service is deployed)
ML_SERVICE_URL=http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080

# CORS/Frontend
FRONTEND_URL=https://nfly.netlify.app

# Email (SendGrid)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=<your-sendgrid-api-key>
EMAIL_FROM=noreply@yourdomain.com

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PREMIUM_PRICE_ID=price_...
STRIPE_PRO_PRICE_ID=price_...

# Optional
ENABLE_SCHEDULER=true
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

### Step 5: Configure Backend Deployment Settings

1. **Root Directory**: `packages/backend`
2. **Start Command**: `npm run start:prod`
3. **Build Command**: (leave default)

---

## Part 3: Railway ML Service Deployment

### Step 1: Create ML Service

1. In the same Railway project, click "+ New"
2. Select "GitHub Repo"
3. Choose your `nfly` repository again
4. This creates a second service

### Step 2: Configure ML Service Settings

1. **Root Directory**: `packages/ml-service`
2. **Dockerfile Path**: `Dockerfile.ml`
3. **Port**: `8080`
4. **Make Private**: Remove public domain (Settings → Networking → Remove Public Domain)

### Step 3: Configure ML Service Environment Variables

```bash
# Database (use same DATABASE_URL from backend)
DATABASE_URL=<copy-from-backend-service>

# Redis (use same REDIS_URL from backend)
REDIS_URL=<copy-from-backend-service>

# Python/ML Settings
DEBUG=false
MODEL_PATH=/app/models
```

---

## Part 4: Configure Private Networking

### Backend → ML Service Communication

1. In **backend** service environment variables
2. Set `ML_SERVICE_URL` to:
   ```
   http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080
   ```
3. Railway will automatically resolve this to the private URL

---

## Part 5: Stripe Integration

### Step 1: Create Stripe Products

1. Go to [Stripe Dashboard](https://dashboard.stripe.com)
2. Create two products:
   - **Premium**: $9.99/month
   - **Pro**: $29.99/month
3. Copy the Price IDs (start with `price_...`)

### Step 2: Configure Stripe Webhook

1. In Stripe Dashboard → Developers → Webhooks
2. Click "Add endpoint"
3. Endpoint URL: `https://nfl-predictorbackend-production.up.railway.app/api/webhooks/stripe`
4. Select events:
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
   - `checkout.session.completed`
5. Copy the Webhook Secret (starts with `whsec_...`)

---

## Part 6: Netlify Frontend Deployment

### Step 1: Connect Repository

1. Go to [Netlify](https://netlify.com)
2. Click "Add new site" → "Import an existing project"
3. Choose GitHub and select your `nfly` repository

### Step 2: Configure Build Settings

```yaml
Base directory: packages/mobile
Build command: npm run build:web
Publish directory: packages/mobile/dist
```

### Step 3: Deploy

1. Click "Deploy site"
2. Wait for build to complete
3. Note your site URL (e.g., `https://nfly.netlify.app/`)

### Step 4: Custom Domain (Optional)

1. Go to Site settings → Domain management
2. Add your custom domain
3. Configure DNS as instructed

---

## Part 7: Verification & Testing

### Step 1: Test Health Endpoints

```bash
# Backend health
curl https://nfl-predictorbackend-production.up.railway.app/health

# Should return:
# {"status":"healthy","timestamp":"...","uptime":...}
```

### Step 2: Test Authentication

```bash
# Register new user
curl -X POST https://nfl-predictorbackend-production.up.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email":"test@example.com",
    "password":"test123456",
    "firstName":"Test",
    "lastName":"User",
    "dateOfBirth":"1990-01-01"
  }'
```

### Step 3: Test Frontend

1. Go to https://nfly.netlify.app/
2. Click "Create Account"
3. Fill in registration form
4. Verify you can log in
5. Test predictions and other features

---

## Troubleshooting

### CORS Errors

If you see CORS errors in the browser console:

1. Check `FRONTEND_URL` in Railway backend variables
2. Verify it matches your Netlify URL exactly
3. Redeploy backend service

### ML Service 502 Errors

If predictions return 502 errors:

1. Check ML service is running in Railway dashboard
2. Verify `ML_SERVICE_URL` uses Railway's private domain syntax:
   ```
   http://${{ml-service.RAILWAY_PRIVATE_DOMAIN}}:8080
   ```
3. Check ML service logs for errors

### Database Connection Errors

1. Verify all database environment variables are set correctly
2. For MongoDB Atlas: Check network access allows Railway IPs
3. For PostgreSQL: Verify `DATABASE_URL` is set by Railway

### Build Failures

**Netlify build fails:**
- Check `build:web` script in `packages/mobile/package.json`
- Verify Expo version is 50+
- Check build logs for specific errors

**Railway build fails:**
- Check logs in Railway dashboard
- Verify root directory and start command are correct
- Check for missing environment variables

---

## Monitoring & Maintenance

### Railway Logs

View logs for debugging:
1. Open service in Railway dashboard
2. Click "Deployments"
3. Select latest deployment
4. Click "View Logs"

### Database Backups

**PostgreSQL** (Railway):
- Automated backups included in paid plans
- Use Railway CLI for manual backups

**MongoDB Atlas**:
- Automated backups included in free tier
- Configure backup schedule in Atlas dashboard

### SSL Certificates

- Railway: Automatically provided
- Netlify: Automatically provided
- Custom domains: Let's Encrypt certificates auto-renew

---

## Scaling

### Railway Scaling

1. Go to service settings
2. Click "Resources"
3. Adjust:
   - CPU allocation
   - Memory limit
   - Replicas (for horizontal scaling)

### Database Scaling

**PostgreSQL**: Upgrade Railway plan for larger database
**MongoDB Atlas**: Upgrade cluster tier
**Redis**: Upgrade Railway Redis instance

---

## Security Best Practices

1. **Rotate Secrets Regularly**:
   - JWT_SECRET
   - STRIPE_SECRET_KEY
   - Database passwords

2. **Monitor Access**:
   - Review Railway access logs
   - Check Stripe webhooks for anomalies
   - Monitor MongoDB Atlas metrics

3. **Update Dependencies**:
   ```bash
   npm audit
   npm audit fix
   ```

4. **Rate Limiting**:
   - Already configured (100 req/15min)
   - Adjust `RATE_LIMIT_MAX_REQUESTS` if needed

---

## Support

For issues:
1. Check logs in Railway/Netlify dashboard
2. Review this guide's troubleshooting section
3. Check GitHub issues
4. Contact support

---

## Quick Reference

### Railway Services

| Service | Port | Public | Purpose |
|---------|------|--------|---------|
| Backend | 4100 | Yes | API server |
| ML Service | 8080 | No | Predictions |
| PostgreSQL | 5432 | No | Game data |
| Redis | 6379 | No | Caching |

### Environment Files

- Backend: `.env` (not committed)
- ML Service: `.env` (not committed)
- Mobile: Config in `app.json`

### Key Commands

```bash
# Local development
npm run install:all        # Install all dependencies
npm run docker:up          # Start local databases
npm run dev:backend        # Run backend locally
npm run dev:ml             # Run ML service locally
npm run dev:mobile         # Run mobile app locally

# Deployment
git push origin master     # Triggers auto-deploy
```
